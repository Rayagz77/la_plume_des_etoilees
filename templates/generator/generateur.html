<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS flipbook (v√©rifie que le fichier existe bien ici) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/generator/flip_book.css') }}">

  <title>G√©n√©rateur d'histoires ‚Äì La Plume des √âtoil√©es</title>

  <style>
    /* ====== Centrage global ====== */
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #f8fafc;
      display: flex;                 /* centre horizontalement le contenu principal */
      flex-direction: column;
      align-items: center;
    }

    /* conteneur centr√© avec largeur max */
    .container {
      width: min(100%, 960px);
      padding: 24px 20px 40px;
      
    }

    h1 { 
      margin: 12px 0 16px;
      text-align: center;            /* titre centr√© */
    }

    /* Formulaire centr√© */
    form {
      margin: 0 auto;
      display: grid;
      gap: 12px;
      background: #fff;
      padding: 16px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
    }
    label { display: grid; gap: 6px; font-weight: 600; }
    input, button {
      padding: 10px; font-size: 16px; border:1px solid #d1d5db; border-radius:8px;
    }
    button { cursor: pointer; background:#111827; color:#fff; border:none; }
    button:hover { filter: brightness(1.05); }
    .mic-btn img { vertical-align: middle; }
    .mic-btn { background:none; border:none; padding:0; }
    .btn-back { display:inline-block;margin-bottom:16px;color:#093163;text-decoration:none; }
    .btn-back:hover { text-decoration:underline; }

    /* Zone d‚Äôaffichage de l‚Äôhistoire + flipbook centr√©s */
    #story-container {
      margin-top: 16px;
      min-height: 80px;
      /* Astuce centrer: */
      text-align: center;            /* centre les √©l√©ments "inline" (les nav-btn) */
      display: block;
    }
    /* Si #book est un bloc classique, margin:auto le centre */
    #book { margin: 16px auto; }

    /* nav buttons ajout√©s par flipbook.js ‚Üí inline + centr√©s */
    #story-container .nav-btn {
      display: inline-block;
      margin: 8px 6px;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #fff;
      cursor: pointer;
    }

    /* Liens de t√©l√©chargement centr√©s */
    .links { margin-top: 12px; text-align: center; }
    .links a { margin: 0 6px; }
  </style>
</head>
<body>
  <div class="container">
    <a href="{{ url_for('home') }}" class="btn-back" aria-label="Retour">&larr; Retour</a>
    <h1>Conte animalier personnalis√©</h1>

    <form id="story-form">
      <label>√Çge cible
        <input type="number" id="age" value="6" min="3" max="10" />
        <button type="button" class="mic-btn" data-target="age" aria-label="Dicter l'√¢ge"><img width="24" height="24" src="https://img.icons8.com/fluency-systems-filled/48/microphone.png" alt="Micro"></button>
      </label>
      <label>Nom du h√©ros
        <input type="text" id="name" value="Axelle" />
        <button type="button" class="mic-btn" data-target="name" aria-label="Dicter le nom"><img width="24" height="24" src="https://img.icons8.com/fluency-systems-filled/48/microphone.png" alt="Micro"></button>
      </label>
      <label>Genre
        <input type="text" id="genre" value="Conte animalier" />
        <button type="button" class="mic-btn" data-target="genre" aria-label="Dicter le genre"><img width="24" height="24" src="https://img.icons8.com/fluency-systems-filled/48/microphone.png" alt="Micro"></button>
      </label>
      <label>√âl√©ments cl√©s
        <input type="text" id="elements" value="animaux qui parlent, rimes, comptine r√©p√©titive" />
        <button type="button" class="mic-btn" data-target="elements" aria-label="Dicter les √©l√©ments"><img width="24" height="24" src="https://img.icons8.com/fluency-systems-filled/48/microphone.png" alt="Micro"></button>
      </label>
      <label>Th√®mes
        <input type="text" id="themes" value="confiance en soi, entraide" />
        <button type="button" class="mic-btn" data-target="themes" aria-label="Dicter les th√®mes"><img width="24" height="24" src="https://img.icons8.com/fluency-systems-filled/48/microphone.png" alt="Micro"></button>
      </label>
      <label>Ton souhait√©
        <input type="text" id="tone" value="joyeux et rassurant" />
        <button type="button" class="mic-btn" data-target="tone" aria-label="Dicter le ton"><img width="24" height="24" src="https://img.icons8.com/fluency-systems-filled/48/microphone.png" alt="Micro"></button>
      </label>
      <button type="submit">G√©n√©rer l'histoire</button>
    </form>

    <div id="story-container" aria-live="polite"></div>
  </div>

  <!-- flipbook + speech -->
  <script src="{{ url_for('static', filename='js/generator/flipbook.js') }}" defer></script>
  <script src="{{ url_for('static', filename='js/speech.js') }}" defer></script>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('story-form');
    const out  = document.getElementById('story-container');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      out.textContent = 'G√©n√©ration en cours...';

      const payload = {
        age: document.getElementById('age').value,
        name: document.getElementById('name').value,
        genre: document.getElementById('genre').value,
        elements: document.getElementById('elements').value,
        themes: document.getElementById('themes').value,
        tone: document.getElementById('tone').value
      };

      try {
        const r = await fetch('/story/api/generate', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await r.json();
        if (!r.ok || !data.story) throw new Error(data.error || 'Erreur inconnue');

        // s√©curiser le texte
        const safe = (s) => String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const safeStory = safe(data.story);

        // construire le flipbook si dispo
        if (window.buildBook) {
          window.buildBook(safeStory);
        } else {
          out.innerHTML = `<pre style="white-space:pre-wrap;margin:0 auto;max-width:760px;text-align:left;">${safeStory}</pre>`;
        }

        // liens de t√©l√©chargement centr√©s
        const actions = document.createElement('div');
        actions.className = 'links';
        actions.innerHTML = `
          <a href="${data.text_url}" download>‚¨áÔ∏è T√©l√©charger .txt</a>
          ${data.audio_url ? ` ‚Ä¢ <a href="${data.audio_url}" download>üéß T√©l√©charger .mp3</a>` : ''}
        `;
        out.appendChild(actions);

      } catch (err) {
        out.textContent = 'Erreur : ' + err.message;
      }
    });
  });
  </script>
</body>
</html>
